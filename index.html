<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movement Detector with GPS and Step Counter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #container {
            max-width: 600px;
            margin: auto;
            text-align: center;
        }
        p {
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Movement Detector with GPS and Step Counter</h1>
        <p id="movementType">Movement: None</p>
        <p id="distanceMoved">Distance Moved: 0 meters</p>
        <p id="stepCount">Steps: 0</p>
    </div>

    <script>
        let accelerationHistory = [];
        const historySize = 5000;
        let lastPosition = null;
        let totalDistance = 0;
        let stepCount = 0;
        const distanceThreshold = 0.2; // Minimum distance in meters to consider as moving
        const stepThreshold = 2.5; // Higher threshold to avoid false positives
        const stepSensitivity = 0.2; // Sensitivity to detect steps
        let isAboveThreshold = false;

        // Function to calculate distance between two GPS coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        // Function to analyze movement type based on acceleration history
        function analyzeMovement(history) {
            if (history.length < historySize) return;

            const mean = history.reduce((sum, value) => sum + value, 0) / history.length;
            const variance = history.reduce((sum, value) => sum + (value - mean) ** 2, 0) / history.length;
            const standardDeviation = Math.sqrt(variance);

            let movementType = 'Unknown';
            if (standardDeviation < 0.2) { // Increased threshold to reduce sensitivity
                movementType = 'Stationary';
            } else if (standardDeviation < 0.6) { // Adjusted for walking
                movementType = 'Walking';
            } else if (standardDeviation < 1.2) { // Adjusted for running
                movementType = 'Running';
            } else {
                movementType = 'Cycling or Other';
            }

            document.getElementById('movementType').textContent = 'Movement: ' + movementType;
        }

        // Function to handle device motion event and detect steps
        function handleMotionEvent(event) {
            const acceleration = event.acceleration;

            if (acceleration) {
                handlePosition()
                const magnitude = Math.sqrt(acceleration.x ** 2 + acceleration.y ** 2 + acceleration.z ** 2);

                // Detect steps based on acceleration magnitude
                if (magnitude > stepThreshold && !isAboveThreshold & handlePosition()) {
                    stepCount++;
                    document.getElementById('stepCount').textContent = 'Steps: ' + stepCount;
                    isAboveThreshold = true;
                } else if (magnitude < stepThreshold - stepSensitivity) {
                    isAboveThreshold = false;
                }

                accelerationHistory.push(magnitude);
                if (accelerationHistory.length > historySize) {
                    accelerationHistory.shift(); // Remove the oldest data point
                }

                analyzeMovement(accelerationHistory);
            }
        }

        // Function to handle geolocation event
        function handlePosition() {
            position = navigator.geolocation.getCurrentPosition()
            if (lastPosition) {
                const distance = calculateDistance(
                    lastPosition.coords.latitude,
                    lastPosition.coords.longitude,
                    position.coords.latitude,
                    position.coords.longitude
                );

                if (distance > distanceThreshold) {
                    totalDistance += distance;
                    document.getElementById('distanceMoved').textContent = 'Distance Moved: ' + totalDistance.toFixed(2) + ' meters';
                }
            }

            lastPosition = position;
            return distance > 0.2;
        }

        // Start listening to device motion and geolocation events
        window.addEventListener('devicemotion', handleMotionEvent);

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition( (error) => {
                console.error('Error accessing location:', error);
            });
        } else {
            console.log('Geolocation is not supported by this browser.');
        }
    </script>
</body>
</html>
